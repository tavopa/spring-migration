name: Spring Boot Migration Pipeline

on:
  workflow_dispatch:
    inputs:
      repos_file:
        description: 'Path to repos.yaml file'
        required: false
        default: 'conf/repos.yaml'
      dry_run:
        description: 'Dry run mode (no PRs created)'
        required: false
        default: false
        type: boolean
  schedule:
    # Ejecutar cada lunes a las 2 AM UTC
    - cron: '0 2 * * 1'

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  setup-matrix:
    name: Setup Repository Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout migration repository
        uses: actions/checkout@v4

      - name: Read repositories list
        id: read-repos
        run: |
          REPOS_FILE="${{ github.event.inputs.repos_file || 'conf/repos.yaml' }}"
          if [ ! -f "$REPOS_FILE" ]; then
            echo "Error: $REPOS_FILE not found"
            exit 1
          fi
          echo "repos<<EOF" >> $GITHUB_OUTPUT
          cat "$REPOS_FILE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Install js-yaml
        run: |
          npm install js-yaml

      - name: Generate matrix
        id: set-matrix
        uses: actions/github-script@v7
        with:
          script: |
            const yaml = require('js-yaml');
            const fs = require('fs');
            const reposContent = `${{ steps.read-repos.outputs.repos }}`;
            const reposConfig = yaml.load(reposContent);
            
            const repos = reposConfig.repositories || [];
            if (repos.length === 0) {
              core.setFailed('No repositories found in repos.yaml');
            }
            
            const matrix = repos.map((repo) => ({
              owner: repo.owner,
              repo: repo.repo,
              branch: repo.branch || 'main'
            }));
            
            core.setOutput('matrix', JSON.stringify({include: matrix}));
            core.info(`Generated matrix for ${repos.length} repositories`);

  migrate-single-repo:
    name: Migrate ${{ matrix.owner }}/${{ matrix.repo }}
    needs: setup-matrix
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.setup-matrix.outputs.matrix) }}
    steps:
      - name: Checkout migration repository
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'maven'

      - name: Read migration config
        id: read-config
        run: |
          echo "config<<EOF" >> $GITHUB_OUTPUT
          cat conf/repos.yaml >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Install js-yaml for config parsing
        run: |
          npm install js-yaml

      - name: Parse migration config
        id: parse-config
        uses: actions/github-script@v7
        with:
          script: |
            const yaml = require('js-yaml');
            const reposContent = `${{ steps.read-config.outputs.config }}`;
            const config = yaml.load(reposContent);
            core.setOutput('target_java', config.migration.target_java_version || '21');
            core.setOutput('target_spring_boot', config.migration.target_spring_boot_version || '3.2.0');
            core.setOutput('recipes', JSON.stringify(config.migration.openrewrite_recipes || []));

      - name: Clone target repository
        uses: actions/checkout@v4
        with:
          repository: ${{ matrix.owner }}/${{ matrix.repo }}
          ref: ${{ matrix.branch }}
          path: target-repo
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Analyze current dependencies
        id: analyze-deps
        working-directory: target-repo
        run: |
          echo "Analyzing Maven dependencies..."
          if [ -f "pom.xml" ]; then
            mvn dependency:tree -DoutputFile=dependencies-before.txt || true
            mvn help:effective-pom -Doutput=effective-pom-before.xml || true
            
            # Extract Java version
            JAVA_VERSION=$(mvn help:evaluate -Dexpression=java.version -q -DforceStdout 2>/dev/null || echo "unknown")
            echo "java_version=$JAVA_VERSION" >> $GITHUB_OUTPUT
            
            # Extract Spring Boot version
            SPRING_BOOT_VERSION=$(mvn help:evaluate -Dexpression=spring-boot.version -q -DforceStdout 2>/dev/null || echo "unknown")
            echo "spring_boot_version=$SPRING_BOOT_VERSION" >> $GITHUB_OUTPUT
            
            echo "Current Java version: $JAVA_VERSION"
            echo "Current Spring Boot version: $SPRING_BOOT_VERSION"
          else
            echo "No pom.xml found, skipping dependency analysis"
            echo "java_version=unknown" >> $GITHUB_OUTPUT
            echo "spring_boot_version=unknown" >> $GITHUB_OUTPUT
          fi

      - name: Update dependencies with OpenRewrite
        id: openrewrite
        working-directory: target-repo
        run: |
          echo "Running OpenRewrite migrations..."
          if [ -f "pom.xml" ]; then
            # Backup original pom.xml
            cp pom.xml pom.xml.backup
            
            # Check if OpenRewrite plugin already exists
            if ! grep -q "rewrite-maven-plugin" pom.xml; then
              # Insert OpenRewrite plugin before </plugins> or </build>
              # Get recipes from config
              RECIPES='${{ steps.parse-config.outputs.recipes }}'
              RECIPES_ARRAY=$(echo "$RECIPES" | jq -r '.[]' || echo "")
              
              # Create plugin configuration
              PLUGIN_CONFIG=$(cat << 'PLUGIN_EOF'
            <plugin>
              <groupId>org.openrewrite.maven</groupId>
              <artifactId>rewrite-maven-plugin</artifactId>
              <version>5.40.0</version>
              <configuration>
                <activeRecipes>
                  <recipe>org.openrewrite.java.migrate.UpgradeToJava21</recipe>
                  <recipe>org.openrewrite.java.spring.boot3.UpgradeSpringBoot_3_2</recipe>
                  <recipe>org.openrewrite.java.migrate.jakarta.JavaxMigrationToJakarta</recipe>
                </activeRecipes>
              </configuration>
              <dependencies>
                <dependency>
                  <groupId>org.openrewrite.recipe</groupId>
                  <artifactId>rewrite-migrate-java</artifactId>
                  <version>20.0.0</version>
                </dependency>
                <dependency>
                  <groupId>org.openrewrite.recipe</groupId>
                  <artifactId>rewrite-spring</artifactId>
                  <version>5.7.0</version>
                </dependency>
              </dependencies>
            </plugin>
          PLUGIN_EOF
              )
              
              # Insert plugin before </plugins> tag
              if grep -q "</plugins>" pom.xml; then
                sed -i "/<\/plugins>/i\\$PLUGIN_CONFIG" pom.xml
              elif grep -q "</build>" pom.xml; then
                # Create plugins section if it doesn't exist
                sed -i "/<\/build>/i\\    <plugins>\\n$PLUGIN_CONFIG\\n    </plugins>" pom.xml
              fi
            fi
            
            # Run OpenRewrite
            mvn rewrite:run || echo "OpenRewrite completed with warnings"
            
            # Check if changes were made
            if [ -n "$(git status --porcelain)" ]; then
              echo "changes_made=true" >> $GITHUB_OUTPUT
            else
              echo "changes_made=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "No pom.xml found, skipping OpenRewrite"
            echo "changes_made=false" >> $GITHUB_OUTPUT
          fi

      - name: Build project to check compilation
        working-directory: target-repo
        run: |
          if [ -f "pom.xml" ]; then
            mvn clean compile -DskipTests || echo "Build failed, continuing..."
          fi

      - name: Analyze JDK compatibility with jdeps
        id: jdeps-analysis
        working-directory: target-repo
        run: |
          echo "Running jdeps analysis..."
          if [ -f "pom.xml" ]; then
            # Find compiled classes
            CLASSES_DIR="target/classes"
            if [ -d "$CLASSES_DIR" ]; then
              # Run jdeps to check for internal API usage
              jdeps --multi-release ${{ steps.parse-config.outputs.target_java }} --jdk-internals "$CLASSES_DIR" > jdeps-report.txt 2>&1 || true
              
              # Check for issues
              if grep -q "JDK internal API" jdeps-report.txt; then
                echo "jdeps_issues=true" >> $GITHUB_OUTPUT
                cat jdeps-report.txt
              else
                echo "jdeps_issues=false" >> $GITHUB_OUTPUT
              fi
            else
              echo "No compiled classes found, skipping jdeps"
              echo "jdeps_issues=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Analyze deprecated APIs with jdeprscan
        id: jdeprscan-analysis
        working-directory: target-repo
        run: |
          echo "Running jdeprscan analysis..."
          if [ -f "pom.xml" ]; then
            CLASSES_DIR="target/classes"
            if [ -d "$CLASSES_DIR" ]; then
              # Run jdeprscan to find deprecated APIs
              jdeprscan --multi-release ${{ steps.parse-config.outputs.target_java }} --class-path "$CLASSES_DIR" "$CLASSES_DIR" > jdeprscan-report.txt 2>&1 || true
              
              # Check for deprecated API usage
              if [ -s jdeprscan-report.txt ] && ! grep -q "no deprecated API usage" jdeprscan-report.txt; then
                echo "deprecated_apis=true" >> $GITHUB_OUTPUT
                cat jdeprscan-report.txt
              else
                echo "deprecated_apis=false" >> $GITHUB_OUTPUT
              fi
            else
              echo "No compiled classes found, skipping jdeprscan"
              echo "deprecated_apis=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Run Unit Tests
        working-directory: target-repo
        run: |
          if [ -f "pom.xml" ]; then
            mvn test -Dtest=**/*Test -DfailIfNoTests=false || echo "Unit tests completed with failures"
          fi

      - name: Run Integration Tests
        working-directory: target-repo
        run: |
          if [ -f "pom.xml" ]; then
            mvn verify -Dtest=**/*IT -DfailIfNoTests=false || echo "Integration tests completed with failures"
          fi

      - name: Run Contract Tests
        working-directory: target-repo
        run: |
          if [ -f "pom.xml" ]; then
            mvn test -Dtest=**/*ContractTest -DfailIfNoTests=false || echo "Contract tests completed with failures"
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image for smoke tests
        working-directory: target-repo
        run: |
          if [ -f "pom.xml" ]; then
            mvn clean package -DskipTests || echo "Build failed, continuing..."
            JAR_FILE=$(find target -name "*.jar" ! -name "*-sources.jar" ! -name "*-javadoc.jar" | head -1)
            if [ -n "$JAR_FILE" ]; then
              cat > Dockerfile << 'EOF'
              FROM eclipse-temurin:21-jre-alpine
              WORKDIR /app
              COPY target/*.jar app.jar
              EXPOSE 8080
              ENTRYPOINT ["java", "-jar", "app.jar"]
              EOF
              docker build -t app:test .
            fi
          fi

      - name: Run Smoke Tests in Container
        working-directory: target-repo
        run: |
          if docker images | grep -q "app:test"; then
            CONTAINER_ID=$(docker run -d -p 8080:8080 app:test || echo "")
            if [ -n "$CONTAINER_ID" ]; then
              sleep 15
              # Wait for app to start and check health endpoint
              for i in {1..30}; do
                if curl -f http://localhost:8080/actuator/health 2>/dev/null || curl -f http://localhost:8080/health 2>/dev/null; then
                  echo "Smoke test passed - application is healthy"
                  break
                fi
                sleep 2
              done
              docker stop $CONTAINER_ID || true
              docker rm $CONTAINER_ID || true
            fi
          else
            echo "Docker image not built, skipping smoke tests"
          fi

      - name: Create migration branch
        working-directory: target-repo
        run: |
          BRANCH_NAME="migration/spring-boot-${{ steps.parse-config.outputs.target_spring_boot }}-java-${{ steps.parse-config.outputs.target_java }}-$(date +%Y%m%d-%H%M%S)"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b "$BRANCH_NAME"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Commit changes
        if: steps.openrewrite.outputs.changes_made == 'true'
        working-directory: target-repo
        run: |
          git add .
          git commit -m "chore: migrate to Spring Boot ${{ steps.parse-config.outputs.target_spring_boot }} and Java ${{ steps.parse-config.outputs.target_java }}

          - Updated dependencies via OpenRewrite
          - Analyzed JDK compatibility with jdeps/jdeprscan
          - Current versions:
            - Java: ${{ steps.analyze-deps.outputs.java_version }} -> ${{ steps.parse-config.outputs.target_java }}
            - Spring Boot: ${{ steps.analyze-deps.outputs.spring_boot_version }} -> ${{ steps.parse-config.outputs.target_spring_boot }}
          
          Requires QA review before merge." || echo "No changes to commit"

      - name: Push changes
        if: steps.openrewrite.outputs.changes_made == 'true' && github.event.inputs.dry_run != 'true'
        working-directory: target-repo
        run: |
          git push origin "$BRANCH_NAME" || echo "Push failed"

      - name: Create Pull Request
        if: steps.openrewrite.outputs.changes_made == 'true' && github.event.inputs.dry_run != 'true'
        uses: actions/github-script@v7
        env:
          REPO_OWNER: ${{ matrix.owner }}
          REPO_NAME: ${{ matrix.repo }}
          BASE_BRANCH: ${{ matrix.branch }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo, baseBranch } = {
              owner: process.env.REPO_OWNER,
              repo: process.env.REPO_NAME,
              baseBranch: process.env.BASE_BRANCH
            };
            
            const branchName = process.env.branch_name;
            
            const prBody = `## Spring Boot Migration
            
            This PR contains automated migration updates for Spring Boot and Java versions.
            
            ### Changes
            - ✅ Dependencies updated via OpenRewrite
            - ✅ JDK compatibility analyzed (jdeps/jdeprscan)
            - ✅ Tests executed (see test matrix results)
            
            ### Version Updates
            - Java: \`${{ steps.analyze-deps.outputs.java_version }}\` → \`${{ steps.parse-config.outputs.target_java }}\`
            - Spring Boot: \`${{ steps.analyze-deps.outputs.spring_boot_version }}\` → \`${{ steps.parse-config.outputs.target_spring_boot }}\`
            
            ### Analysis Reports
            - jdeps issues: ${{ steps.jdeps-analysis.outputs.jdeps_issues }}
            - Deprecated APIs: ${{ steps.jdeprscan-analysis.outputs.deprecated_apis }}
            
            ### ⚠️ Requires QA Review
            This PR requires manual QA review before merging.
            
            ---
            *Generated by Spring Boot Migration Pipeline*`;
            
            try {
              const pr = await github.rest.pulls.create({
                owner,
                repo,
                title: `chore: migrate to Spring Boot ${{ steps.parse-config.outputs.target_spring_boot }} and Java ${{ steps.parse-config.outputs.target_java }}`,
                head: branchName,
                base: baseBranch,
                body: prBody,
                draft: false
              });
              
              // Add requires QA label
              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number: pr.data.number,
                labels: ['requires QA', 'automated', 'migration']
              });
              
              // Request review (optional - uncomment if you want to auto-assign reviewers)
              // await github.rest.pulls.requestReviewers({
              //   owner,
              //   repo,
              //   pull_number: pr.data.number,
              //   reviewers: ['reviewer-username']
              // });
              
              core.info(`Created PR #${pr.data.number}: ${pr.data.html_url}`);
              core.setOutput('pr_number', pr.data.number);
              core.setOutput('pr_url', pr.data.html_url);
            } catch (error) {
              core.error(`Failed to create PR: ${error.message}`);
              throw error;
            }

